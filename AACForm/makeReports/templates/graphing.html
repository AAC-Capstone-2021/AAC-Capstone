{% extends 'base.html' %}
{% load bootstrap4 %}
{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script src="//unpkg.com/babel-polyfill@latest/dist/polyfill.min.js"></script>
<script src="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.js"></script>
<!-- Include Choices CSS -->
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css"
/>
<!-- Include Choices JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script type='text/javascript'></script>
<div id="vapp">
{% endblock %}
{% block styles %}
<meta charset='utf-8' />
<link
type="text/css"
rel="stylesheet"
href="//unpkg.com/bootstrap/dist/css/bootstrap.min.css"
/>
<link
type="text/css"
rel="stylesheet"
href="//unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue.css"
/> 
<style>
    #hide-sam{
        display: inherit;
    }
    #hide-freq{
        display: inherit;
    }
</style>
{% endblock %}
{% block content %}
<h3>Historical Data</h3>
<div class="row">
    <div class="col-6">

{% if user.profile.aac %}
    <h4>College:</h4>
    <div class="dd_col">
        <select id="id_college" v-model="college" v-on:change="updateDept" name="college">
            {% for c in colleges %}
                <option value="{{c.pk}}">{{ c.name }}</option>
            {% endfor %}
        </select>
    </div>
    <h4>Department:</h4>
    <div class="dd_dept">
        <select id="id_department" v-model="department" v-on:change="updateProg" name="department">
            <template v-for="d in depts">
                    <option v-bind:value="d.pk">[[d.name]]</option>
            </template>
        </select>
    </div>
{% endif %}
<h4>Degree program:</h4>
<div class="dd_dprog">
    <select id="id_prog" v-model="program" name="program" v-on:change="updateSLOs">
            <option value="1">All Programs</option>
        <template v-for="p in progs">
            <option v-bind:value="p.pk">[[p.name]] ([[p.level]])</option>
        </template>
    </select>
</div>
<h4>Date Range</h4>
<div class="dd_drange1">
    <select id="id_range1" v-model="date1" v-on:change="updateSLOs"></select>
</div>
<h5>to</h5>
<div class="dd_drange2">
    <select id="id_range2" v-model="date2" v-on:change="updateSLOs"></select>
</div>
<h4>Graph type:</h4>
<template v-if="program == 1">
    <div class="dd_graph">
        <select id="id_graph" v-model="graph_opt">
            <option value="3">Number of degree programs meeting target</option>
        </select>
    </div>
</template>
<template v-if="program != 1">
    <div class="dd_graph">
        <select id="id_graph" v-model="graph_opt" v-on:change="changeGraphOpt">
            <option value="1">Specific SLO and Assessment: target v. actual</option>
            <option value="2">Number of SLOs met</option>
        </select>
    </div>
</template>
<template v-if="graph_opt == 1">
    <h4>SLO (displayed as in most recent report):</h4>
    <div class="specific">
        <select id="spec" v-model="slo" v-on:change="updateAssesses">
            <template v-for="s in slos">
                <option v-bind:value="s.pk">[[s.goalText]]</option>
            </template>
        </select>
    </div>
    <h4>Assessment</h4>
    <div class="specific">
        <select id="assess" v-model="assess">
            <template v-for="a in assesses">
                <option v-bind:value="a.pk">[[a.assessment.title]]</option>
            </template>
        </select>
    </div>
</template>
<br>
<template v-if="date1!=null && date2!=null && graph_opt>0">
<button class='btn btn-primary' v-on:click="newGraph">View Graph</button> 
</template>
<br>
</div>
<div class="col-6">
    <img v-if="url!=null && !graphError" :src="url" width="100%"></img>
    <template v-if="graphError">
    <p>No graph to display.</p>
    </template>
</div>
</div>
{% endblock %}
{% block endscripts %}
    <script>
    var start = 2015;
    var end = new Date().getFullYear();
    var options = "";
    for (var year = end; year >= start; year--)
    {
        options += "<option>"+ year + "</option>";
    }
    document.getElementById("id_range1").innerHTML = options;
    document.getElementById("id_range2").innerHTML = options;
    var vapp = new Vue({
            el: '#vapp',
            delimiters: ['[[', ']]'],
            data: { 
                assess: null,
                assesses: null,
                depts: null,
                progs: null,
                slos: null,
                graph_opt: 0,
                department: null,
                college: null,
                program: 1,
                date1: null,
                date2: null,
                slo: null,
                url: null,
                ch: null,
                graphError: false
            },
            //computed: {
            //},
            //mounted(){
            //    this.ch = new Choices(document.getElementById('spec'),{shouldSort:false});
            //},
            methods: {
                /**
                * Calls the API to update the department based upon the chosen college
                */
                updateDept: function () {
                    fetch("{% url 'makeReports:api-dept-by-col' %}?college="+this.college)
                        .then(response => {
                            response.clone().json()
                        .then(json => {
                            this.depts = json;
                        })
                    });
                    this.updateProg();
                },
                /**
                * Calls the API to update the degree programs based upon the chosen department
                *
                */
                updateProg: function() {
                    fetch("{% url 'makeReports:api-prog-by-dept' %}?department="+this.department)
                        .then(response => {
                            response.clone().json()
                        .then(json => {
                            this.progs = json;
                        })
                    });
                },
                changeGraphOpt: function(){
                    if(this.graph_opt==1){
                        this.$nextTick(function(){
                            //have to wait for DOM to change to attach ChoicesJS to dropdown
                            this.ch = new Choices(document.getElementById('spec'),{shouldSort:false});
                            this.updateSLOs();
                        });
                    }
                },
                /**
                * Calls the API to update the SLOs based upon the chosen degree program.
                * It also creates a new instance of the ChoicesJS object (i.e. fancy dropdown) if necessary
                *
                */
                updateSLOs: function() {
                    if(this.graph_opt==1){
                        fetch("{% url 'makeReports:api-slo-by-dp' %}?report__degreeProgram="+this.program
                        +"&report__year__gte="+this.date1+"&report__year__lte="+this.date2)
                            .then(response => {
                                response.clone().json()
                            .then(json => {
                                this.slos = json;
                                this.ch.setChoices(this.slos,'pk','goalText',true);
                                //this.$nextTick(function () {
                                    //have to wait for DOM to update so there is a select to be replaced
                                    //this.ch = new Choices(document.getElementById('spec'),{shouldSort:false});
                                    //if(this.slos!=undefined && this.ch!=undefined){
                                 //   this.ch.setChoices(this.slos,'pk','goalText',true);
                                //});
                            })
                        });
                        
                    }
                },
                updateAssesses: function(){
                    if(this.graph_opt==1){
                        sloHere = this.slos.find(el => el.pk==this.slo);
                        console.log(sloHere)
                        fetch("{% url 'makeReports:api-assess-by-slo' %}?slo__slo="+sloHere.slo.pk
                        +"&report__year__gte="+this.date1+"&report__year__lte="+this.date2)
                            .then(response => {
                                response.clone().json()
                            .then(json => {
                                this.assesses = json;
                            })
                        });
                        
                    }
                },
                /**
                * Calls the API to generate the chosen graph based upon selected options
                */
                newGraph: function() {
                    assessHere = this.assesses.find(el => el.pk==this.assess);
                    fetch("{% url 'makeReports:api-new-graph' %}?report__degreeProgram__department="
                    +this.department+"&report__degreeProgram="+this.program+"&report__year__gte="+this.date1+
                    "&report__year__lte="+this.date2+"&decision="+this.graph_opt+"&sloIR="+this.slo+"&assess="+assessHere.assessment.pk)
                        .then(response => {
                            if(response.status == 200){
                                this.graphError = false
                                response.clone().json().then(json => {
                                    this.url = json;
                                })   
                            }else{
                                this.graphError = true
                            }
                        })
                }
            }
    });
    </script>
{% endblock %}